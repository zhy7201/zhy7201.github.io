<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <title>乐驾学车</title>
        <script src="vue.min.js"></script>
        <script type="text/javascript" src="pdf.js"></script>
        <script type="text/javascript" src="jweixin-1.3.2.js"></script>
        <style>
            .canvas-container {
                overflow-x: scroll;
                padding-bottom: 50px;
            }

            .bottom-btns {
                position: fixed;
                left: 0;
                right: 0;
                bottom: 0;
                height: 50px;
                background-color: #FFC200;
            }

            .bottom-btns .btn {
                width: 100%;
                line-height: 50px;
                color: white;
                text-align: center;
            }

            .bottom-btns .btns {
                display: flex;
                line-height: 50px;
            }

            .bottom-btns .btns .btn-left {
                color: white;
                text-align: center;
                flex-grow: 1;
            }

            .bottom-btns .btns .line {
                width: 2px;
                background-color: white;
                margin: 5px 0;
            }

            .bottom-btns .btns .btn-right {
                color: white;
                text-align: center;
                flex-grow: 1;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <div class="canvas-container">
                <canvas v-for="i in pageTotal" :id="'the-canvas' + i"></canvas>
            </div>

            <div class="bottom-btns">
                <div v-if="uploaded" class="btn" @click="downloadContract">下载合同</div>
                <div v-else class="btns">
                    <div class="btn-left" @click="navToSignature">去签名</div>
                    <div class="line"></div>
                    <div class="btn-right" @click="uploadContractInfo">上传合同</div>
                </div>
            </div>
        </div>

        <script>
            new Vue({
                el: '#app',
                data: {
                    pageTotal: 0,
                    uploaded: true,
                    pdfURL: ""
                },
                mounted() {
                    console.log("================= mounted ======= ")
                    this.$nextTick(function () {
                        console.log("window.location = ", window.location)
                        let para = this.getPara(window.location.search);
                        this.uploaded = para.uploaded
                        this.pdfURL = para.pdfURL
                        this.init()
                    })
                },
                methods: {
                    getPara(href) {
                        let params = href.split("?")[1];
                        let paramArr = params.split('&');
                        let res = {};
                        for (let i = 0; i < paramArr.length; i++) {
                            let str = paramArr[i].split('=');
                            res[str[0]] = str[1];
                        }
                        console.log(res)
                        return res
                    },
                    init() {
                        pdfjsLib.GlobalWorkerOptions.workerSrc = './pdf.worker.js';
                        let loadingTask = pdfjsLib.getDocument(this.pdfURL);
                        loadingTask.promise.then(pdf => {
                            this.pageTotal = pdf.numPages
                            for (let i = 0; i < pdf.numPages; i++) {
                                pdf.getPage(i + 1).then(function (page) {
                                    let scale = 1;
                                    let viewport = page.getViewport({scale: scale});
                                    let canvas = document.getElementById('the-canvas' + (i + 1));
                                    if (canvas !== null && canvas.getContext('2d') !== null) {
                                        let context = canvas.getContext('2d');
                                        canvas.height = viewport.height;
                                        canvas.width = viewport.width;
                                        let renderContext = {
                                            canvasContext: context,
                                            viewport: viewport,
                                        };
                                        page.render(renderContext);
                                    }
                                });
                            }
                        })
                    },
                    downloadContract() {
                        console.log("下载合同")
                    },
                    navToSignature() {
                        console.log("去签名")

                        // wx.miniProgram.navigateTo({url: '/sub2_package/pages/contractsignature/contractsignature',
                        //     complete:res=>{console.log(res)}
                        // })
                        wx.miniProgram.navigateTo({
                            url: '../../sub2_package/pages/contractsignature/contractsignature',
                            complete: res => {
                                console.log('res = ', res)
                            }
                        })
                    },
                    uploadContractInfo() {
                        console.log("上传合同")
                        console.log("window.location = ", window.location)
                    }
                },
            })
        </script>
    </body>
</html>
